<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${Editando ? 'Editar Obra: ' + obra.nombreObra : 'Detalle de Obra: ' + obra.nombreObra}"></title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/CSS/dashboard.css}">
  <link rel="stylesheet" th:href="@{/CSS/MATERIALES/detalleMaterial.css}">
  <link rel="stylesheet" th:href="@{/CSS/OBRAS/verObra.css}">
</head>
<body>
<button id="menu-toggle" class="menu-toggle">
  <i class="fas fa-bars"></i>
</button>
<div class="app-container" id="app-container">
  <!-- Sidebar (Mantenido de la estructura) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img th:src="@{/IMG/imagen-bob.png}" alt="BOB Logo">
      <h1>BOB</h1>
    </div>
    <ul class="nav-links">
      <div sec:authorize="isAuthenticated()">
        <li><a th:href="@{/redirigir}"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_USUARIO', 'EDITAR_USUARIO')">
        <li><a th:href="@{/usuarios}"><i class="fas fa-users-cog"></i> <span>Gestión de Usuarios</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_INVENTARIO', 'EDITAR_INVENTARIO')">
        <li><a th:href="@{/inventarios}"><i class="fas fa-box"></i> <span>Inventario</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_MATERIAL', 'EDITAR_MATERIAL')">
        <li><a th:href="@{/material/inicioMaterial}"><i class="fas fa-calculator"></i> <span>Gestión de materiales</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_APU', 'EDITAR_APU')">
        <li><a th:href="@{/apu/inicioAPU}"><i class="fas fa-calculator"></i> <span>Gestión de APUs</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_AVANCE', 'EDITAR_AVANCE')">
        <li><a th:href="@{/avances/inicioAvances}"><i class="fas fa-hard-hat"></i> <span>Avances</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_OBRA', 'EDITAR_OBRA', 'LEER_OBRA')">
        <li><a th:href="@{/obras/inicioObra}"><i class="fas fa-money-bill-wave"></i> <span>Obras</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_CONTRATISTA', 'EDITAR_CONTRATISTA')">
        <li><a th:href="@{/contratistas}"><i class="fas fa-handshake"></i> <span>Contratistas</span></a></li>
      </div>
      <div sec:authorize="hasAnyAuthority('CREAR_PROVEEDOR', 'EDITAR_PROVEEDOR')">
        <li><a href="/proveedores"><i class="fas fa-truck-loading"></i> <span>Proveedores</span></a></li>
      </div>
      <li>
        <form th:action="@{/logout}" method="post" id="logoutForm">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <a href="#" onclick="document.getElementById('logoutForm').submit()">
            <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
          </a>
        </form>
      </li>
    </ul>
  </aside>

  <!-- Main content -->
  <main class="main-content">
    <!-- Header -->
    <div class="header">
      <div>
        <h2 th:text="${Editando ? 'Editar Obra' : 'Detalle de Obra'}"><i class="fas fa-building"></i> Detalle de Obra</h2>
        <p th:text="${Editando ? 'Modificando proyecto ID: ' + obra.idObra : 'Información completa del proyecto ' + obra.nombreObra}"></p>
      </div>
      <div class="user-menu">
        <div class="user-avatar">
          <span sec:authentication="name" th:text="${#strings.substring(name, 0, 1)}"></span>
        </div>
        <div>
          <div>Bienvenido <span sec:authentication="name"></span></div>
          <div>
                        <span class="role-badge admin-badge" sec:authorize="hasRole('ADMIN')">
                            <i class="fas fa-shield-alt"></i> Administrador
                        </span>
            <span class="role-badge supervisor-badge" sec:authorize="hasRole('SUPERVISOR')">
                            <i class="fas fa-user-check"></i> Supervisor
                        </span>
            <span class="role-badge operativo-badge" sec:authorize="hasRole('OPERATIVO')">
                            <i class="fas fa-user"></i> Operativo
                        </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="header-actions" style="margin-bottom: 2rem;">
      <a th:href="@{/obras/inicioObra}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver a Obras
      </a>

      <div th:unless="${Editando}">
        <a th:href="@{/obras/cambiar/} + ${obra.idObra}"
           class="btn btn-warning"
           sec:authorize="hasAuthority('EDITAR_OBRA')">
          <i class="fas fa-edit"></i> Editar Obra
        </a>
      </div>
    </div>

    <!-- Detail Card / Edit Form -->
    <div class="detail-card">
      <div class="detail-header">
        <h2 th:text="${obra.nombreObra}">Nombre de la Obra</h2>
        <div th:classappend="${obra.etapa == 'PRESU'} ? 'badge-warning' : (${obra.etapa == 'EJECU'} ? 'badge-primary' : 'badge-secondary')"
             class="status-badge" th:text="${obra.etapa}">Etapa</div>
      </div>

      <div class="detail-body">
        <!-- FORMULARIO DE EDICIÓN (Editando = true) -->
        <form th:if="${Editando}"
              th:action="@{${obra.idObra != null ? '/obras/actualizar/' + obra.idObra : '/obras/salvar'}}"
              method="post"
              th:object="${obra}">

          <input type="hidden" th:field="*{idObra}">

          <!-- Información General (Editable) -->
          <div class="detail-section">
            <h3><i class="fas fa-info-circle"></i> Información General</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="nombreObra" class="detail-label required">Nombre de la obra</label>
                <input type="text" id="nombreObra" th:field="*{nombreObra}" class="form-input" required maxlength="255">
              </div>
              <div class="form-group">
                <label for="etapa" class="detail-label required">Etapa</label>
                <select id="etapa" th:field="*{etapa}" class="form-select" required>
                  <option value="PRESU" th:selected="${obra.etapa == 'PRESU'}">Presupuesto</option>
                  <option value="EJECU" th:selected="${obra.etapa == 'EJECU'}">Ejecución</option>
                  <option value="LIQUI" th:selected="${obra.etapa == 'LIQUI'}">Liquidación</option>
                </select>
              </div>
              <div class="form-group">
                <label for="fechaIni" class="detail-label required">Fecha de inicio</label>
                <input type="date" id="fechaIni" th:field="*{fechaIni}" class="form-input" required>
              </div>
              <div class="form-group">
                <label for="fechaFin" class="detail-label required">Fecha de fin</label>
                <input type="date" id="fechaFin" th:field="*{fechaFin}" class="form-input" required>
              </div>
              <div class="form-group">
                <label for="cooNObra" class="detail-label required">Coordenada N</label>
                <input type="number" id="cooNObra" th:field="*{cooNObra}" step="0.000001" class="form-input" required>
              </div>
              <div class="form-group">
                <label for="cooEObra" class="detail-label required">Coordenada E</label>
                <input type="number" id="cooEObra" th:field="*{cooEObra}" step="0.000001" class="form-input" required>
              </div>
            </div>
          </div>


          <!-- Bloque de Actividades (Editable) -->
          <div class="detail-section">
            <h3><i class="fas fa-hammer"></i> Actividades (APU)</h3>

            <div id="actividadesContainer">
              <!-- Loop through existing activities -->
              <div th:each="apuObraC, stat : ${apusObraCant}" class="activity-edit-row">
                <select th:name="'apus[' + ${stat.index} + ']'" required class="form-select activity-select">
                  <option value="">Seleccione...</option>
                  <option th:each="apu : ${todosApus}"
                          th:value="${apu.idAPU}"
                          th:data-nombre="${apu.nombreAPU}"
                          th:data-unidades="${apu.unidadesAPU}"
                          th:text="${apu.nombreAPU} + ' - (' + ${apu.unidadesAPU} + ')'"
                          th:selected="${apu.idAPU == apuObraC.apu.idAPU}">
                  </option>
                </select>
                <input type="number" th:name="'cantidades[' + ${stat.index} + ']'"
                       step="0.01" min="0.01" th:value="${apuObraC.cantidad}" placeholder="Cantidad" required class="form-input activity-quantity">
                <span class="btn-remove" onclick="removeActivity(this)">
                                    <i class="fas fa-times-circle"></i> Eliminar
                                </span>
              </div>

              <!-- If no activities exist, the JS will ensure one is added -->
            </div>

            <button type="button" onclick="addActivity()" class="btn btn-success" style="margin-top: 1rem;">
              <i class="fas fa-plus"></i> Añadir otra actividad
            </button>
          </div>

          <!-- Submit Button -->
          <div class="form-actions" style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
          </div>
        </form>

        <!-- VISTA DE DETALLE (Editando = false) -->
        <div th:unless="${Editando}">
          <!-- Información General (Detalle) -->
          <div class="detail-section">
            <h3><i class="fas fa-info-circle"></i> Información Básica</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">ID de Obra</span>
                <div class="detail-value" th:text="${obra.idObra}">ID</div>
              </div>
              <div class="detail-item">
                <span class="detail-label">Fecha de Inicio</span>
                  <div class="detail-value" th:text="${#temporals.format(obra.fechaIni, 'dd-MM-yyyy')}">Fecha Ini</div>
              </div>
              <div class="detail-item">
                <span class="detail-label">Fecha de Fin</span>
                  <div class="detail-value" th:text="${#temporals.format(obra.fechaFin, 'dd-MM-yyyy')}">Fecha Fin</div>
              </div>
              <div class="detail-item">
                <span class="detail-label">Coordenada N</span>
                <div class="detail-value" th:text="${obra.cooNObra}">Coo N</div>
              </div>
              <div class="detail-item">
                <span class="detail-label">Coordenada E</span>
                <div class="detail-value" th:text="${obra.cooEObra}">Coo E</div>
              </div>
              <div class="detail-item">
                <span class="detail-label">Valor Total Estimado (APUs)</span>
                <!-- Asumo que tienes una variable con el valor total -->
                <div class="detail-value total-value" th:text="${'₡' + #numbers.formatDecimal(valorTotalEstimado, 1, 2)}">₡ 0.00</div>
              </div>
            </div>
          </div>

          <!-- Tabla de Actividades (Detalle) -->
          <div class="detail-section">
            <h3><i class="fas fa-list-alt"></i> Actividades del Proyecto (APU)</h3>
            <div th:if="${obra.apusObraList != null and !obra.apusObraList.empty}" class="table-responsive">
              <table class="data-table">
                <thead>
                <tr>
                  <th>ID APU</th>
                  <th>Nombre de Actividad</th>
                  <th>Unidad</th>
                  <th>Cantidad</th>
                  <th>Costo Unitario (APU)</th>
                  <th>Subtotal</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="apuo, iterStat : ${obra.apusObraList}">
                    <td th:text="${apuo.apu.idAPU}"></td>
                    <td th:text="${apuo.apu.nombreAPU}"></td>
                    <td th:text="${apuo.apu.unidadesAPU}"></td>
                    <td th:text="${apuo.cantidad}"></td>
                    <!-- Use valApusObra list that contains pre-calculated APU prices -->
                    <td th:text="${valApusObra != null ? '₡' + #numbers.formatDecimal(valApusObra[iterStat.index], 1, 2) : 'N/A'}"></td>
                    <!-- Calculate subtotal: cantidad * precio unitario from valApusObra -->
                    <td th:with="subtotal=${apuo.cantidad * (valApusObra != null ? valApusObra[iterStat.index] : 0)}"
                        th:text="${'₡' + #numbers.formatDecimal(subtotal, 1, 2)}">
                    </td>
                </tr>
                </tbody>
              </table>
            </div>
            <div th:if="${obra.apusObraList == null or obra.apusObraList.empty}">
              <p class="no-activities"><i class="fas fa-info-circle"></i> No hay actividades registradas para esta obra.</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Additional Action Buttons (Hidden when editing) -->
    <div th:unless="${Editando}" class="header-actions" style="justify-content: center; margin-top: 1rem;">
      <a th:href="@{/obras/inicioObra}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver a Obras
      </a>
      <a th:href="@{/obras/cambiar/} + ${obra.idObra}"
         class="btn btn-warning"
         sec:authorize="hasAuthority('EDITAR_OBRA')">
        <i class="fas fa-edit"></i> Editar Obra
      </a>
    </div>
  </main>
</div>

<!-- JavaScript para gestión dinámica de APUs en modo Edición -->
<script th:if="${Editando}">
  // Variable para manejar el índice de los arrays en Thymeleaf
  let nextIndex = document.querySelectorAll('.activity-edit-row').length;

  /**
   * Clones la última fila de actividad y actualiza los nombres de los inputs.
   * Si no hay filas, crea una desde cero usando el primer select como plantilla.
   */
  function addActivity() {
      const container = document.getElementById('actividadesContainer');
      const existingRows = container.querySelectorAll('.activity-edit-row');

      if (existingRows.length > 0) {
          // Clonar la última fila existente
          const lastRow = existingRows[existingRows.length - 1];
          const newRow = lastRow.cloneNode(true);

          // Actualizar los atributos name para el nuevo índice
          newRow.querySelector('.activity-select').name = 'apus[' + nextIndex + ']';
          newRow.querySelector('.activity-select').value = ''; // Resetear valor
          newRow.querySelector('.activity-quantity').name = 'cantidades[' + nextIndex + ']';
          newRow.querySelector('.activity-quantity').value = ''; // Resetear valor

          // Actualizar el onclick del botón de eliminar (si aplica)
          const removeBtn = newRow.querySelector('.btn-remove');
          if(removeBtn) {
              removeBtn.onclick = function() { removeActivity(this); };
          }

          container.appendChild(newRow);
      } else {
          // Si no hay filas, necesitamos crear la estructura base
          createNewEmptyRow(container);
      }

      nextIndex++;
  }

  /**
   * Crea una fila vacía y la añade al contenedor, usando el select principal como plantilla
   */
  function createNewEmptyRow(container) {
      // En modo edición, el controlador debe pasar `todosApus`
      const templateSelect = document.querySelector('select[name^="apus"]');
      if (!templateSelect) {
          alert("Error: No se encontró la plantilla de APUs. Asegúrese de que el modelo 'todosApus' esté disponible.");
          return;
      }

      const newRow = document.createElement('div');
      newRow.className = 'activity-edit-row';

      // Clonar Select
      const select = templateSelect.cloneNode(true);
      select.name = 'apus[' + nextIndex + ']';
      select.value = '';
      select.classList.add('activity-select'); // Asegura la clase

      // Crear Input Cantidad
      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.name = 'cantidades[' + nextIndex + ']';
      quantityInput.step = '0.01';
      quantityInput.min = '0.01';
      quantityInput.placeholder = 'Cantidad';
      quantityInput.required = true;
      quantityInput.classList.add('form-input', 'activity-quantity');

      // Crear Botón de Eliminar
      const removeBtn = document.createElement('span');
      removeBtn.className = 'btn-remove';
      removeBtn.innerHTML = '<i class="fas fa-times-circle"></i> Eliminar';
      removeBtn.onclick = function() { removeActivity(this); };

      newRow.appendChild(select);
      newRow.appendChild(quantityInput);
      newRow.appendChild(removeBtn);

      container.appendChild(newRow);
  }


  /**
   * Elimina una fila de actividad del DOM.
   * @param {HTMLElement} element - El botón o span de eliminar.
   */
  function removeActivity(element) {
      const row = element.closest('.activity-edit-row');
      if (row) {
          row.remove();
          // No es necesario reindexar los nombres de los inputs en el lado del cliente
          // El backend debe manejar los arrays dispersos (apus[0], apus[2], etc.)
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
      // --- Inicialización y Lógica de Edición ---
      const container = document.getElementById('actividadesContainer');
      // Si el controlador pasa una lista vacía, el contenedor está vacío.
      // Aseguramos que haya al menos una fila editable al inicio si no hay actividades.
      if (container && container.querySelectorAll('.activity-edit-row').length === 0) {
          // Solo si estamos editando una obra que no tiene APUs aún
          if (nextIndex === 0) {
               createNewEmptyRow(container);
          }
      }


      // --- Lógica de Control del Menú Móvil ---
      const menuToggle = document.getElementById('menu-toggle');
      const appContainer = document.getElementById('app-container');
      const sidebar = document.querySelector('.sidebar');
      const menuIcon = menuToggle ? menuToggle.querySelector('i') : null;

      if (menuToggle && appContainer && sidebar && menuIcon) {
          menuToggle.addEventListener('click', function() {
              appContainer.classList.toggle('sidebar-active');
              if (appContainer.classList.contains('sidebar-active')) {
                  menuIcon.classList.remove('fa-bars');
                  menuIcon.classList.add('fa-times');
              } else {
                  menuIcon.classList.remove('fa-times');
                  menuIcon.classList.add('fa-bars');
              }
          });

          document.addEventListener('click', (e) => {
              if (window.innerWidth <= 768 && appContainer.classList.contains('sidebar-active')) {
                  if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                      appContainer.classList.remove('sidebar-active');
                      menuIcon.classList.remove('fa-times');
                      menuIcon.classList.add('fa-bars');
                  }
              }
          });
      }
  });
</script>
</body>
</html>