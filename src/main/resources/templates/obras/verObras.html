<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <!-- Dynamic title based on edit/view mode -->
  <title th:text="${Editando ? 'Editar Proyecto' : 'Detalle de Proyecto'}"></title>

  <style>



    /* Style for each material row */
    .material-row {
        margin: 10px 0;
        padding: 5px;
        border: 1px solid #ddd;
    }

    /* Base styles for form elements */
    input, select, button {
        margin: 5px 0;
        display: block;
    }

    /* Style for remove buttons */
    .btn-remove {
        color: red;
        cursor: pointer;
        margin-left: 10px;
    }

    /* Base button styling */
    .btn {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin: 10px 0;
    }

    /* Container for activities section */
    #actividadesContainer {
        margin: 20px 0;
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }
  </style>
</head>

<body>
<!-- Dynamic heading based on edit/view mode -->
<h1 th:text="${Editando ? 'Editar Proyecto (ID: ' + obra.idObra + ')' :
                  'Detalle de Proyecto'}"></h1>

<!-- Back button -->
<a th:href="@{/obras/inicioObra}" class="btn">Regresar</a>
<br><br>

<!-- Edit form (shown only in edit mode) -->
<form th:if="${Editando}"
      th:action="@{${obra.idObra != null ? '/obras/actualizar/' + obra.idObra : '/obras/salvar'}}"
      method="post"
      th:object="${obra}">

  <input type="hidden" th:field="*{idObra}">

  <!-- Work name input (editable in edit mode) -->
  <div th:if="${Editando}">
    <label><b>Nombre de la obra:</b></label>
    <input type="text" th:field="*{NombreObra}" name="NombreObra" required>
  </div>

  <!-- Display work name (view mode) -->
  <h2 th:unless="${Editando}" th:text="${obra.NombreObra}"></h2>

  <h3>Actividades:</h3>

  <!--  different display based on mode -->
  <div th:if="${Editando}">
    <!-- Edit mode  interface -->
    <div id="actividadesContainer">
      <!-- Check if there are existing activities -->
      <div th:if="${not #lists.isEmpty(actividadIds)}">
      <!-- Loop through existing activities -->
      <div th:each="apu, stat : ${apusObra}" class="material-row">
        <select name="apus" required>
          <option value="">Seleccione...</option>
          <option th:each="apu : ${APUs}"
                  th:value="${apu.idAPU}"
                  th:data-nombre="${apu.nombreAPU}"
                  th:data-unidades="${apu.unidadesAPU}"
                  th:text="${apu.nombreAPU} + ' - (' + ${apu.unidadesAPU} + ')'">
          </option>
        <input type="number" name="cantidades" step="0.01" min="0.01"
               th:value="${cantidades[stat.index]}" placeholder="Cantidad" required>
        <span class="btn-remove" onclick="removeActivity(this)">✕ Eliminar</span>
        </select>
      </div>
      </div>

      <!-- Empty row template for new materials -->
      <!-- <div th:if="${actividadesConCantidad == null or actividadesConCantidad.empty}" class="material-row">
        <select name="actividadIds" required>
          <option value="">Seleccione actividad...</option>
          <option th:each="act : ${actividades}"
                  th:value="${act.id_m}"
                  th:text="${#strings.abbreviate(act.nombre, 100) + ' (' + act.unidades + ')'}">
          </option>
        </select>
        <input type="number" name="quantities" step="0.01" min="0.01" placeholder="Cantidad" required>
        <span class="btn-remove" onclick="removeRow(this)">✕ Eliminar</span>
      </div>
    </div>-->

    <button type="button" onclick="addActivity()" class="btn" style="background-color: #2196F3;">
      + Añadir otra actividad
    </button>
    <br><br>

    <button type="submit" class="btn">Guardar presupuesto</button>
  </div>

  <!-- View mode display -->
  <div th:unless="${Editando}">
    <div th:if="${apusObra != null and !apusObra.empty}">
      <table>
        <thead>
        <tr>
          <th>ID Actividad</th>
          <th>Nombre</th>
          <th>Unidades</th>
          <th>Cantidad</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="apu : ${apusObra}">
          <td th:text="${apu.idAPU}"></td>
          <td th:text="${apu.nombreAPU}"></td>
          <td th:text="${apu.unidadesAPU}"></td>
        </tr>
        </tbody>
      </table>
    </div>
    <div th:if="${apusObra == null or apusObra.empty}">
      <p>No hay actividades registradas para este presupuesto</p>
    </div>
  </div>
  </div>
</form>

<!-- View mode display when not editing -->
<div th:unless="${Editando}">
  <h2 th:text="${obra.nombreObra}"></h2>
  <h2 th:text="${v}"></h2>

  <h3>actividades:</h3>
  <div th:if="${apusObra != null and !apusObra.empty}">
    <table>
      <thead>
      <tr>
        <th>ID Material</th>
        <th>Nombre</th>
        <th>Unidades</th>
        <th>Cantidad</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="apuo : ${obra.apusObraList}">
        <td th:text="${apuo.apu.idAPU}"></td>
        <td th:text="${apuo.apu.nombreAPU}"></td>
        <td th:text="${apuo.apu.unidadesAPU}"></td>
        <td th:text="${apuo.cantidad}"></td>
      </tr>
      </tbody>
    </table>
  </div>
  <!-- TODO imlementar esto mismo en el modo editar acá y en el controlador, ver el tema del valor total  -->
  <div th:if="${obra.apusObraList == null or obra.apusObraList.empty}">
    <p>No hay actividades registradas para este presupuesto</p>
  </div>
</div>

<!-- JavaScript for dynamic form behavior -->
<script th:if="${Editando}">
  /**
   * Adds a new material row to the form
   */
  function addActivity() {
        const container = document.getElementById('actividadesContainer');

        // Create new row div
        const newRow = document.createElement('div');
        newRow.className = 'material-row';

        // Create the select dropdown
        const select = document.createElement('select');
        select.name = 'apus';
        select.required = true;

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Seleccione...';
        select.appendChild(defaultOption);

        // Add options from Thymeleaf (this will be filled by the browser)
        const options = document.querySelectorAll('select[name="apus"] option:not([value=""])');
        options.forEach(option => {
            const newOption = option.cloneNode(true);
            select.appendChild(newOption);
        });

        // Create quantity input
        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.name = 'cantidades';
        quantityInput.step = '0.01';
        quantityInput.min = '0.01';
        quantityInput.placeholder = 'Cantidad';
        quantityInput.required = true;

        // Create remove button
        const removeBtn = document.createElement('span');
        removeBtn.className = 'btn-remove';
        removeBtn.textContent = '✕ Eliminar';
        removeBtn.onclick = function() { removeActivity(this); };

        // Append all elements to the row
        newRow.appendChild(select);
        newRow.appendChild(quantityInput);
        newRow.appendChild(removeBtn);

        // Add the row to the container
        container.appendChild(newRow);
    }



    function removeActivity(element) {
               // Remove visual element
        element.parentElement.remove();

    }


  // Initialize the form when page loads
  document.addEventListener('DOMContentLoaded', function() {
      if (document.querySelectorAll('.material-row').length === 0) {
          addActivity();
      }
  });
</script>
</body>
</html>