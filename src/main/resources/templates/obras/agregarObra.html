<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Crear Nueva Obra</title>

    <style>
        .material-row {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #ddd;
        }

        input, select, button {
            margin: 5px 0;
            display: block;
        }

        .btn-remove {
            color: red;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .btn-add {
            background-color: #2196F3;
        }

        .selected-activity {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }

        .form-group {
            margin: 10px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<h1>Crear Nueva Obra</h1>

<!-- Back button -->
<a th:href="@{/obras/inicioObra}" class="btn">Regresar</a>
<br><br>

<!-- Create Form -->
<form th:action="@{/obras/salvar}" method="post">
    <!-- Campos básicos de la obra -->
    <div class="form-group">
        <label><b>Nombre de la obra:</b></label>
        <input type="text" name="nombreObra" required>
    </div>

    <div class="form-group">
        <label><b>Etapa:</b></label>
        <select id="Rol" name="rolSeleccionado" required>
            <option value="">Seleccionar Rol...</option>
            <option value="PRESU">Presupuesto</option>
            <option value="EJECU">Ejecución</option>
            <option value="LIQUI">Liquidación</option>
    </div>

    <div class="form-group">
        <label><b>Fecha de inicio:</b></label>
        <input type="date" name="fechaIni" required>
    </div>

    <div class="form-group">
        <label><b>Fecha de fin:</b></label>
        <input type="date" name="fechaFin" required>
    </div>

    <div class="form-group">
        <label><b>Coordenada N:</b></label>
        <input type="number" step="0.000001" name="cooNObra" required>
    </div>

    <div class="form-group">
        <label><b>Coordenada E:</b></label>
        <input type="number" step="0.000001" name="cooEObra" required>
    </div>

    <h3>Actividades (APU):</h3>

    <!-- Single dropdown for selection -->
    <div>
        <select id="activityDropdown">
            <option value="">Seleccione...</option>
            <option th:each="apu : ${APUs}"
                    th:value="${apu.idAPU}"
                    th:data-nombre="${apu.nombreAPU}"
                    th:data-unidades="${apu.unidadesAPU}"
                    th:text="${apu.nombreAPU} + ' (' + ${apu.unidadesAPU} + ')'">
            </option>
        </select>

        <input type="number" id="activityQuantity" step="0.01" min="0.01" placeholder="Cantidad">

        <button type="button" onclick="addActivity()" class="btn btn-add">
            Añadir actividad
        </button>
    </div>

    <br>

    <!-- Container for selected activities -->
    <div id="selectedActivities">
        <!-- Selected activities will appear here -->
    </div>

    <br>

    <!-- Hidden inputs that will be submitted -->
    <div id="hiddenInputs"></div>

    <!-- Submit Button -->
    <button type="submit" class="btn">Guardar</button>
</form>

<script>
    // Store activities as an array of objects for better management
    let activities = [];

    function addActivity() {
        const dropdown = document.getElementById('activityDropdown');
        const quantityInput = document.getElementById('activityQuantity');

        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const activityId = parseInt(selectedOption.value);
        const activityName = selectedOption.getAttribute('data-nombre');
        const activityUnits = selectedOption.getAttribute('data-unidades');
        const quantity = parseFloat(quantityInput.value);

        // Validate inputs
        if (isNaN(activityId) || activityId <= 0) {
            alert("Por favor seleccione una actividad válida");
            return;
        }

        if (isNaN(quantity) || quantity <= 0) {
            alert("Por favor ingrese una cantidad válida");
            return;
        }

        // Check for duplicates
        if (activities.some(act => act.id === activityId)) {
            alert("Esta actividad ya fue agregada");
            return;
        }

        // Add activity to visible list
        activities.push({
            id: activityId,
            name: activityName,
            units: activityUnits,
            quantity: quantity
        });

        updateActivityUI();
        resetFormInputs();
    }

    function removeActivity(activityId) {
        activities = activities.filter(act => act.id !== parseInt(activityId));
        updateActivityUI();
    }

    function updateActivityUI() {
        const selectedActivitiesDiv = document.getElementById('selectedActivities');
        const hiddenInputsDiv = document.getElementById('hiddenInputs');

        // Clear UI
        selectedActivitiesDiv.innerHTML = '';
        hiddenInputsDiv.innerHTML = '';

        // Rebuild UI and hidden inputs
        activities.forEach((activity, index) => {
            // Visible UI element
            const activityDiv = document.createElement('div');
            activityDiv.className = 'selected-activity';
            activityDiv.innerHTML = `
                <span>${activity.name} (${activity.units}) - Cantidad: ${activity.quantity}</span>
                <span class="btn-remove" onclick="removeActivity(${activity.id})">✕ Eliminar</span>
            `;
            selectedActivitiesDiv.appendChild(activityDiv);

            // Hidden inputs for form submission - usando los nombres que espera el controlador
            addHiddenInput(hiddenInputsDiv, 'apuIds', activity.id);
            addHiddenInput(hiddenInputsDiv, 'cantidades', activity.quantity);
        });
    }

    function addHiddenInput(container, name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        container.appendChild(input);
    }

    function resetFormInputs() {
        document.getElementById('activityDropdown').selectedIndex = 0;
        document.getElementById('activityQuantity').value = '';
    }

    // Initialize the form when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateActivityUI();
    });
</script>
</body>
</html>