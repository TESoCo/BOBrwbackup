<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Materiales - Building Optimization Baseline</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/CSS/dashboard.css}">
    <link rel="stylesheet" th:href="@{/CSS/AVANCES/agregarAvance.css}">
</head>
<body>
<button id="menu-toggle" class="menu-toggle">
    <i class="fas fa-bars"></i>
</button>
<div class="app-container" id="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img th:src="@{/IMG/imagen-bob.png}" alt="BOB Logo">
            <h1>BOB</h1>
        </div>
        <ul class="nav-links">

            <!-- Dashboard - Para todos los usuarios autenticados -->
            <div sec:authorize="isAuthenticated()">
                <li><a th:href="@{/redirigir}"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
            </div>

            <!-- Gesti√≥n de Usuarios - Solo con permisos de usuario -->
            <div sec:authorize="hasAnyAuthority('CREAR_USUARIO', 'EDITAR_USUARIO')">
                <li><a th:href="@{/usuarios}"><i class="fas fa-users-cog"></i> <span>Gesti√≥n de Usuarios</span></a></li>
            </div>

            <!-- Menu items for users with inventory permissions -->
            <!-- Inventario - Con permisos de inventario -->
            <div sec:authorize="hasAnyAuthority('CREAR_INVENTARIO', 'EDITAR_INVENTARIO')">
                <li><a th:href="@{/inventarios}"><i class="fas fa-box"></i> <span>Inventario</span></a></li>
            </div>

            <!-- Materiales - Con permisos de material -->
            <div sec:authorize="hasAnyAuthority('CREAR_MATERIAL', 'EDITAR_MATERIAL')">
                <li><a th:href="@{/material/inicioMaterial}"><i class="fas fa-calculator"></i> <span>Gesti√≥n de materiales</span></a></li>
            </div>

            <!-- APUs - Con permisos de APU -->
            <div sec:authorize="hasAnyAuthority('CREAR_APU', 'EDITAR_APU')">
                <li><a th:href="@{/apu/inicioAPU}"><i class="fas fa-calculator"></i> <span>Gesti√≥n de APUs</span></a></li>
            </div>

            <!-- Menu items for users with progress permissions -->
            <!-- Avances - Con permisos de avance -->
            <div sec:authorize="hasAnyAuthority('CREAR_AVANCE', 'EDITAR_AVANCE')">
                <li><a th:href="@{/avances/inicioAvances}"><i class="fas fa-hard-hat"></i> <span>Avances</span></a></li>
            </div>

            <!-- Menu items for users with budget permissions -->
            <!-- Obras - Con permisos de obra -->
            <div sec:authorize="hasAnyAuthority('CREAR_OBRA', 'EDITAR_OBRA', 'LEER_OBRA')">
                <li><a th:href="@{/obras/inicioObra}"><i class="fas fa-money-bill-wave"></i> <span>Obras</span></a></li>
            </div>

            <!-- Supervisor and Admin menu items -->
            <!-- Contratistas - Con permisos de contratista -->
            <div sec:authorize="hasAnyAuthority('CREAR_CONTRATISTA', 'EDITAR_CONTRATISTA')">
                <li><a th:href="@{/contratistas}"><i class="fas fa-handshake"></i> <span>Contratistas</span></a></li>
            </div>
            <!-- Proveedores - Con permisos de proveedor -->
            <div sec:authorize="hasAnyAuthority('CREAR_PROVEEDOR', 'EDITAR_PROVEEDOR')">
                <li><a href="#"><i class="fas fa-truck-loading"></i> <span>Proveedores</span></a></li>
            </div>

            <!-- Menu items for users with report permissions -->
            <!-- Reportes - Para roles ADMIN y SUPERVISOR
            <div sec:authorize="hasAnyRole('ADMIN', 'SUPERVISOR')">
              <li><a href="#"><i class="fas fa-chart-line"></i> <span>Reportes</span></a></li>
            </div> -->

            <!-- Fotodatos - Con permisos de fotodato
            <div sec:authorize="hasAnyAuthority('CREAR_FOTODATO', 'EDITAR_FOTODATO')">
              <li><a href="#"><i class="fas fa-camera"></i> <span>Fotodatos</span></a></li>
            </div> -->

            <!-- Admin-only configuration -->
            <!-- Configuraci√≥n - Solo ADMIN
            <div sec:authorize="hasRole('ADMIN')">
              <li><a href="#"><i class="fas fa-cog"></i> <span>Configuraci√≥n</span></a></li>
            </div> -->

            <li>
                <form th:action="@{/logout}" method="post" id="logoutForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <a href="#" onclick="document.getElementById('logoutForm').submit()">
                        <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesi√≥n</span>
                    </a>
                </form>
            </li>
        </ul>
    </aside>

    <!-- Main content -->
    <main class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <h2>Lista de Avances de Obra</h2>
                <p>Administra los Avances de las Obras</p>
            </div>
            <div class="user-menu">
                <div class="user-avatar">
                    <span sec:authentication="name" th:text="${#strings.substring(name, 0, 1)}"></span>
                </div>
                <div>
                    <div>Bienvenido <span sec:authentication="name"></span></div>
                    <div>
                        <span class="role-badge admin-badge" sec:authorize="hasRole('ADMIN')">
                            <i class="fas fa-shield-alt"></i> Administrador
                        </span>
                        <span class="role-badge supervisor-badge" sec:authorize="hasRole('SUPERVISOR')">
                            <i class="fas fa-user-check"></i> Supervisor
                        </span>
                        <span class="role-badge operativo-badge" sec:authorize="hasRole('OPERATIVO')">
                            <i class="fas fa-user"></i> Operativo
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back button -->
        <div class="mb-3">
            <a th:href="@{/avances/inicioAvances}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Regresar
            </a>
        </div>

        <!-- SUGERENCIA DE OBRA BASADA EN UBICACI√ìN -->
        <div class="form-container suggestion-container">
            <div class="suggestion-header">
                <i class="fas fa-lightbulb"></i>
                <h3 style="margin: 0;">Sugerencia de Obra</h3>
            </div>

            <div class="location-info">
                <p id="locationStatus">Obteniendo ubicaci√≥n para sugerir obra m√°s cercana...</p>
                <input type="hidden" id="currentCooN">
                <input type="hidden" id="currentCooE">

                <div id="obraSuggestion" class="suggestion-card">
                    <h4 style="color: #0369a1; margin-bottom: 10px; display: flex; align-items: center;">
                        <i class="fas fa-map-marker-alt"></i>
                        Obra Sugerida
                        <span id="distanceBadge" class="distance-badge"></span>
                    </h4>
                    <p id="suggestionText" style="margin-bottom: 10px; line-height: 1.5;"></p>
                    <div class="suggestion-actions">
                        <button type="button" id="useSuggestionBtn" class="btn btn-primary btn-sm">
                            <i class="fas fa-check"></i> Usar esta obra
                        </button>
                        <button type="button" id="ignoreSuggestionBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Ignorar sugerencia
                        </button>
                    </div>
                </div>

                <div id="noSuggestion" class="suggestion-card" style="display: none;">
                    <h4 style="color: #64748b; margin-bottom: 10px;">
                        <i class="fas fa-info-circle"></i> Informaci√≥n
                    </h4>
                    <p id="noSuggestionText" style="margin-bottom: 0;"></p>
                </div>
            </div>
        </div>

        <!-- Create Form -->
        <div class="form-container">
            <form th:action="@{/avances/salvar}" method="post" enctype="multipart/form-data" th:object="${avance}" id="avanceForm">
                <!-- Work Name Input -->
                <div class="form-group">
                    <label for="obraDropdown"><b>Nombre de la obra:</b></label>
                    <select id="obraDropdown" name="idObra" class="form-control" required>
                        <option value="">Seleccione una obra...</option>
                        <option th:each="obra : ${obras}"
                                th:value="${obra.idObra}"
                                th:text="${obra.nombreObra}">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fechaAvance"><b>Fecha:</b></label>
                    <input type="date" name="fecha" id="fechaAvance" max="hoy" class="form-control" required>
                </div>

                <div class="form-group">
                    <h3>Actividad:</h3>

                    <!-- Activity selection -->
                    <div class="activity-row">
                        <div class="activity-select">
                            <select id="activityDropdown" name="idApu" class="form-control" required disabled>
                                <option value="">Primero, seleccione una obra</option>
                            </select>
                        </div>

                        <div class="quantity-input">
                            <input type="number" id="inputcantidad" name="cantidad" step="0.01" min="0.01"
                                   placeholder="Cantidad" class="form-control quantity-input" required disabled>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de Foto (Opcional) -->
                <div class="form-group">
                    <h3>üì∏ Foto del Avance (Opcional)</h3>

                    <div class="camera-section" style="display: none;" id="cameraSection">
                        <div class="video-container" style="margin-bottom: 15px;">
                            <video id="video" autoplay playsinline style="width: 100%; border: 2px solid #ddd; border-radius: 8px;"></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                        </div>

                        <div class="controls" style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                            <button type="button" id="startCamera" class="btn btn-primary">
                                <i class="fas fa-camera"></i> Iniciar C√°mara
                            </button>
                            <button type="button" id="capturePhoto" class="btn btn-success" disabled>
                                <i class="fas fa-camera"></i> Capturar Foto
                            </button>
                            <button type="button" id="retakePhoto" class="btn btn-secondary" disabled>
                                <i class="fas fa-redo"></i> Volver a Capturar
                            </button>
                        </div>

                        <!-- Vista previa de foto capturada -->
                        <div id="photoPreview" style="display: none; text-align: center; margin: 20px 0;">
                            <h4>Vista Previa de la Foto</h4>
                            <img id="capturedImage" style="max-width: 100%; max-height: 300px; border: 2px solid #10b981; border-radius: 8px;">
                        </div>
                    </div>

                    <!-- Input para archivo de foto -->
                    <div class="form-group">
                        <label>O subir archivo de foto:</label>
                        <input type="file" id="photoFile" name="photoFile" accept="image/*" class="form-control">
                        <small class="text-muted">Formatos aceptados: JPG, PNG, JPEG (M√°ximo 8MB)</small>
                    </div>

                    <!-- Informaci√≥n de foto a guardar -->
                    <input type="hidden" id="photoBase64" name="photoBase64">
                    <input type="hidden" id="photoCooN" name="photoCooN">
                    <input type="hidden" id="photoCooE" name="photoCooE">
                </div>


                <!-- Hidden inputs that will be submitted -->
                <div id="hiddenInputs">
                    <input type="hidden" name="idUsuario" value="4">

                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <i class="fas fa-save"></i> Guardar
                </button>
            </form>
        </div>




    </main>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos de la sugerencia
        const locationStatus = document.getElementById('locationStatus');
        const currentCooN = document.getElementById('currentCooN');
        const currentCooE = document.getElementById('currentCooE');
        const obraSuggestion = document.getElementById('obraSuggestion');
        const noSuggestion = document.getElementById('noSuggestion');
        const suggestionText = document.getElementById('suggestionText');
        const distanceBadge = document.getElementById('distanceBadge');
        const useSuggestionBtn = document.getElementById('useSuggestionBtn');
        const ignoreSuggestionBtn = document.getElementById('ignoreSuggestionBtn');
        const noSuggestionText = document.getElementById('noSuggestionText');

        // Elementos del formulario
        const obraDropdown = document.getElementById('obraDropdown');
        const activityDropdown = document.getElementById('activityDropdown');
        const cantidadInput = document.getElementById('inputcantidad');
        const submitBtn = document.getElementById('submitBtn');

        // Elementos de la c√°mara
        const cameraSection = document.getElementById('cameraSection');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const startCameraBtn = document.getElementById('startCamera');
        const capturePhotoBtn = document.getElementById('capturePhoto');
        const retakePhotoBtn = document.getElementById('retakePhoto');
        const photoPreview = document.getElementById('photoPreview');
        const photoBase64 = document.getElementById('photoBase64');
        const photoCooN = document.getElementById('photoCooN');
        const photoCooE = document.getElementById('photoCooE');
        const photoFile = document.getElementById('photoFile');

        let stream = null;
        let currentLocation = null;

        // Obtener todas las obras del dropdown
        function obtenerObrasDisponibles() {
            const obras = [];
            const options = obraDropdown.querySelectorAll('option[data-coon]');

            options.forEach(option => {
                if (option.value) {
                    obras.push({
                        idObra: option.value,
                        nombreObra: option.textContent,
                        cooNObra: parseFloat(option.getAttribute('data-coon')),
                        cooEObra: parseFloat(option.getAttribute('data-cooe')),
                        etapa: option.getAttribute('data-etapa')
                    });
                }
            });

            return obras;
        }

        // Funci√≥n para calcular distancia (f√≥rmula Haversine)
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distancia en km
        }

        // Encontrar obra m√°s cercana
        function encontrarObraMasCercana(lat, lng) {
            const obras = obtenerObrasDisponibles();
            let obraMasCercana = null;
            let distanciaMinima = Infinity;

            obras.forEach(obra => {
                if (obra.cooNObra && obra.cooEObra) {
                    const distancia = calcularDistancia(lat, lng, obra.cooNObra, obra.cooEObra);
                    if (distancia < distanciaMinima) {
                        distanciaMinima = distancia;
                        obraMasCercana = obra;
                    }
                }
            });

            return { obra: obraMasCercana, distancia: distanciaMinima };
        }

        // Obtener ubicaci√≥n y sugerir obra
        function getLocationAndSuggestObra() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };

                        locationStatus.innerHTML =
                            `<strong>üìç Ubicaci√≥n obtenida:</strong><br>
                             Latitud: ${currentLocation.latitude.toFixed(6)}<br>
                             Longitud: ${currentLocation.longitude.toFixed(6)}`;

                        currentCooN.value = currentLocation.latitude;
                        currentCooE.value = currentLocation.longitude;
                        photoCooN.value = currentLocation.latitude;
                        photoCooE.value = currentLocation.longitude;

                        // Mostrar secci√≥n de c√°mara
                        cameraSection.style.display = 'block';

                        // Buscar obra m√°s cercana
                        const resultado = encontrarObraMasCercana(
                            currentLocation.latitude,
                            currentLocation.longitude
                        );

                        if (resultado.obra && resultado.distancia < 50) { // M√°ximo 50km
                            const distanciaTexto = resultado.distancia < 1
                                ? `${(resultado.distancia * 1000).toFixed(0)}m`
                                : `${resultado.distancia.toFixed(1)}km`;

                            distanceBadge.textContent = distanciaTexto;
                            suggestionText.innerHTML =
                                `<strong>${resultado.obra.nombreObra}</strong><br>
                                 <small>Etapa: ${resultado.obra.etapa || 'No especificada'}</small>`;

                            obraSuggestion.style.display = 'block';
                        } else {
                            noSuggestionText.textContent = resultado.obra
                                ? `La obra m√°s cercana est√° a ${resultado.distancia.toFixed(1)}km. Seleccione manualmente.`
                                : 'No se encontraron obras cercanas con coordenadas. Seleccione manualmente.';
                            noSuggestion.style.display = 'block';
                        }
                    },
                    error => {
                        console.error('Error obteniendo ubicaci√≥n:', error);
                        let errorMessage = 'No se pudo obtener la ubicaci√≥n';

                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Permiso de ubicaci√≥n denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Informaci√≥n de ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Tiempo de espera agotado';
                                break;
                        }

                        locationStatus.innerHTML =
                            `<strong>‚ö†Ô∏è ${errorMessage}</strong><br>
                             Puede seleccionar manualmente una obra`;

                        cameraSection.style.display = 'block';
                        noSuggestionText.textContent = 'Seleccione manualmente una obra del listado.';
                        noSuggestion.style.display = 'block';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                locationStatus.innerHTML =
                    '<strong>‚ùå Geolocalizaci√≥n no soportada</strong><br>' +
                    'Seleccione manualmente una obra';

                cameraSection.style.display = 'block';
                noSuggestionText.textContent = 'Seleccione manualmente una obra del listado.';
                noSuggestion.style.display = 'block';
            }
        }

        // Event listeners para los botones de sugerencia
        useSuggestionBtn.addEventListener('click', function() {
            const obras = obtenerObrasDisponibles();
            const resultado = encontrarObraMasCercana(currentLocation.latitude, currentLocation.longitude);

            if (resultado.obra) {
                obraDropdown.value = resultado.obra.idObra;
                obraDropdown.dispatchEvent(new Event('change'));
                obraSuggestion.style.display = 'none';
                locationStatus.innerHTML += '<br><br>‚úÖ <strong>Obra sugerida seleccionada</strong>';
            }
        });

        ignoreSuggestionBtn.addEventListener('click', function() {
            obraSuggestion.style.display = 'none';
            locationStatus.innerHTML += '<br><br>‚ÑπÔ∏è <strong>Sugerencia ignorada</strong>';
        });

        // Funciones de c√°mara
        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                capturePhotoBtn.disabled = false;
                startCameraBtn.disabled = true;
            } catch (err) {
                console.error('Error al acceder a la c√°mara:', err);
                alert('No se pudo acceder a la c√°mara: ' + err.message);
            }
        }

        function capturePhoto() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convertir a Base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            capturedImage.src = imageData;
            photoBase64.value = imageData;
            photoPreview.style.display = 'block';

            // Detener c√°mara
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            capturePhotoBtn.disabled = true;
            retakePhotoBtn.disabled = false;
        }

        function retakePhoto() {
            photoPreview.style.display = 'none';
            photoBase64.value = '';
            capturedImage.src = '';
            startCamera();
            retakePhotoBtn.disabled = true;
        }

        // Event listeners de c√°mara
        startCameraBtn.addEventListener('click', startCamera);
        capturePhotoBtn.addEventListener('click', capturePhoto);
        retakePhotoBtn.addEventListener('click', retakePhoto);

        // Manejar archivo subido
        photoFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validar tama√±o (8MB m√°ximo)
                if (file.size > 8 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. M√°ximo 8MB.');
                    this.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    photoBase64.value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // C√≥digo existente para el dropdown de actividades
        obraDropdown.addEventListener('change', function() {
            const selectedObraId = this.value;
            console.log('Obra seleccionada ID:', selectedObraId);

            activityDropdown.innerHTML = '<option value="">Cargando actividades...</option>';
            activityDropdown.disabled = true;
            cantidadInput.disabled = true;
            cantidadInput.value = '';
            submitBtn.disabled = true;

            if (!selectedObraId) {
                activityDropdown.innerHTML = '<option value="">Primero seleccione una obra</option>';
                updateFormState();
                return;
            }

            fetch(`/avances/obtenerAPUsPorObra/${selectedObraId}`)
                .then(response => {
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(text => {
                            throw new Error(`El servidor devolvi√≥: ${contentType || 'sin content-type'}`);
                        });
                    }

                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(apus => {
                    console.log('APUs recibidos:', apus);

                    activityDropdown.innerHTML = '<option value="">Seleccione una actividad...</option>';

                    if (apus && apus.length > 0) {
                        apus.forEach(apu => {
                            const option = document.createElement('option');
                            option.value = apu.idAPU;
                            const nombre = apu.nombreAPU || 'Sin nombre';
                            const unidades = apu.unidadesAPU || 'Sin unidades';
                            option.textContent = `${nombre} (${unidades})`;
                            activityDropdown.appendChild(option);
                        });
                        activityDropdown.disabled = false;
                        console.log(`Se cargaron ${apus.length} actividades`);
                    } else {
                        activityDropdown.innerHTML = '<option value="">No hay actividades disponibles para esta obra</option>';
                        console.warn('No se encontraron actividades para esta obra');
                    }

                    updateFormState();
                })
                .catch(error => {
                    console.error('Error al cargar actividades:', error);
                    activityDropdown.innerHTML = '<option value="">Error: ' + error.message + '</option>';
                    updateFormState();
                });
        });

        activityDropdown.addEventListener('change', updateFormState);
        cantidadInput.addEventListener('input', updateFormState);

        function updateFormState() {
            const obraSelected = obraDropdown.value !== '';
            const activitySelected = activityDropdown.value !== '';
            const cantidadValid = cantidadInput.value && parseFloat(cantidadInput.value) > 0;

            cantidadInput.disabled = !activitySelected;
            submitBtn.disabled = !(obraSelected && activitySelected && cantidadValid);
        }

        // Iniciar obtenci√≥n de ubicaci√≥n
        getLocationAndSuggestObra();

        // --- L√≥gica de Control del Men√∫ M√≥vil ---
        const menuToggle = document.getElementById('menu-toggle');
        const appContainer = document.getElementById('app-container');
        const sidebar = document.querySelector('.sidebar');
        const menuIcon = menuToggle ? menuToggle.querySelector('i') : null;

        if (menuToggle && appContainer && sidebar && menuIcon) {
            // 1. Alternar la clase y el √≠cono al hacer clic
            menuToggle.addEventListener('click', function() {
                appContainer.classList.toggle('sidebar-active');

                // Cambiar el √≠cono (fa-bars <-> fa-times)
                if (appContainer.classList.contains('sidebar-active')) {
                    menuIcon.classList.remove('fa-bars');
                    menuIcon.classList.add('fa-times'); // √çcono de cerrar
                } else {
                    menuIcon.classList.remove('fa-times');
                    menuIcon.classList.add('fa-bars'); // √çcono de men√∫
                }
            });

            // 2. Cerrar el men√∫ al hacer clic fuera (solo en m√≥vil)
            document.addEventListener('click', (e) => {
                // Solo para pantallas peque√±as (<= 768px)
                if (window.innerWidth <= 768 && appContainer.classList.contains('sidebar-active')) {
                    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                        appContainer.classList.remove('sidebar-active');

                        // Asegura que el √≠cono vuelva a 'bars'
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                    }
                }
            });
        }

        const hoy = new Date().toISOString().split("T")[0];
  document.getElementById("fecha").setAttribute("max", hoy);


    });




</script>
</body>
</html>