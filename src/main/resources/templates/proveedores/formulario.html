<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Proveedores - Construction Optimization Baseline</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" th:href="@{/CSS/dashboard.css}">
  <link rel="stylesheet" th:href="@{/CSS/PROVEEDORES/formularioProveedores.css}">
</head>
<body>
<button id="menu-toggle" class="menu-toggle">
  <i class="fas fa-bars"></i>
</button>
<div class="app-container" id="app-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img th:src="@{/IMG/imagen-bob.png}" alt="BOB Logo">
      <h1>BOB</h1>
    </div>
    <ul class="nav-links">
      <!-- Dashboard - Para todos los usuarios autenticados -->
      <div sec:authorize="isAuthenticated()">
        <li><a th:href="@{/redirigir}"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
      </div>

      <!-- Gestión de Usuarios - Solo con permisos de usuario -->
      <div sec:authorize="hasAnyAuthority('CREAR_USUARIO', 'EDITAR_USUARIO')">
        <li><a th:href="@{/usuarios}"><i class="fas fa-users-cog"></i> <span>Gestión de Usuarios</span></a></li>
      </div>

      <!-- Menu items for users with inventory permissions -->
      <!-- Inventario - Con permisos de inventario -->
      <div sec:authorize="hasAnyAuthority('CREAR_INVENTARIO', 'EDITAR_INVENTARIO')">
        <li><a th:href="@{/inventarios}"><i class="fas fa-box"></i> <span>Inventario</span></a></li>
      </div>

      <!-- Materiales - Con permisos de material -->
      <div sec:authorize="hasAnyAuthority('CREAR_MATERIAL', 'EDITAR_MATERIAL')">
        <li><a th:href="@{/material/inicioMaterial}"><i class="fas fa-calculator"></i> <span>Gestión de materiales</span></a></li>
      </div>

      <!-- APUs - Con permisos de APU -->
      <div sec:authorize="hasAnyAuthority('CREAR_APU', 'EDITAR_APU')">
        <li><a th:href="@{/apu/inicioAPU}"><i class="fas fa-calculator"></i> <span>Gestión de APUs</span></a></li>
      </div>

      <!-- Menu items for users with progress permissions -->
      <!-- Avances - Con permisos de avance -->
      <div sec:authorize="hasAnyAuthority('CREAR_AVANCE', 'EDITAR_AVANCE')">
        <li><a th:href="@{/avances/inicioAvances}"><i class="fas fa-hard-hat"></i> <span>Avances</span></a></li>
      </div>

      <!-- Menu items for users with budget permissions -->
      <!-- Obras - Con permisos de obra -->
      <div sec:authorize="hasAnyAuthority('CREAR_OBRA', 'EDITAR_OBRA', 'LEER_OBRA')">
        <li><a th:href="@{/obras/inicioObra}"><i class="fas fa-money-bill-wave"></i> <span>Obras</span></a></li>
      </div>

      <!-- Supervisor and Admin menu items -->
      <!-- Contratistas - Con permisos de contratista -->
      <div sec:authorize="hasAnyAuthority('CREAR_CONTRATISTA', 'EDITAR_CONTRATISTA')">
        <li><a th:href="@{/contratistas}"><i class="fas fa-handshake"></i> <span>Contratistas</span></a></li>
      </div>
      <!-- Proveedores - Con permisos de proveedor -->
      <div sec:authorize="hasAnyAuthority('CREAR_PROVEEDOR', 'EDITAR_PROVEEDOR')">
        <li><a href="/proveedores"><i class="fas fa-truck-loading"></i> <span>Proveedores</span></a></li>
      </div>

      <!-- Menu items for users with report permissions -->
      <!-- Reportes - Para roles ADMIN y SUPERVISOR
      <div sec:authorize="hasAnyRole('ADMIN', 'SUPERVISOR')">
        <li><a href="#"><i class="fas fa-chart-line"></i> <span>Reportes</span></a></li>
      </div> -->

      <!-- Fotodatos - Con permisos de fotodato
      <div sec:authorize="hasAnyAuthority('CREAR_FOTODATO', 'EDITAR_FOTODATO')">
        <li><a href="#"><i class="fas fa-camera"></i> <span>Fotodatos</span></a></li>
      </div> -->

      <!-- Admin-only configuration -->
      <!-- Configuración - Solo ADMIN
      <div sec:authorize="hasRole('ADMIN')">
        <li><a href="#"><i class="fas fa-cog"></i> <span>Configuración</span></a></li>
      </div> -->

      <li>
        <form th:action="@{/logout}" method="post" id="logoutForm">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <a href="#" onclick="document.getElementById('logoutForm').submit()">
            <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
          </a>
        </form>
      </li>
    </ul>
  </aside>

    <main class="main-content">
      <!-- Header -->
      <div class="header">
        <div>
          <h2>Formulario de Proveedores</h2>
        </div>
        <div class="user-menu">
          <div class="user-avatar">
            <span sec:authentication="name" th:text="${#strings.substring(name, 0, 1)}"></span>
          </div>
          <div>
            <div>Bienvenido <span sec:authentication="name"></span></div>
            <div>
                    <span class="role-badge admin-badge" sec:authorize="hasRole('ADMIN')">

                        <i class="fas fa-shield-alt"></i> Administrador
                    </span>
              <span class="role-badge supervisor-badge" sec:authorize="hasRole('SUPERVISOR')">
                        <i class="fas fa-user-check"></i> Supervisor
                    </span>
              <span class="role-badge operativo-badge" sec:authorize="hasRole('OPERATIVO')">
                        <i class="fas fa-user"></i> Operativo
                    </span>
            </div>
          </div>
        </div>
      </div>

      <div class="dashboard-content">

        <!-- Header del formulario -->
        <div class="supplier-header">
          <h1><i class='bx bx-user-plus'></i> Registrar Proveedor</h1>
          <div class="breadcrumb">
            <a th:href="@{/proveedores/inicioProveedor}">
              <i class='bx bx-hard-hat'></i> Proveedores
            </a>
            <span>/</span>
            <span>Nuevo</span>
          </div>
        </div>

        <!-- Mostrar mensajes de error -->
        <div th:if="${error}" class="alert alert-danger" style="margin: 20px; padding: 15px; background: #f8d7da; color: #721c24; border-radius: 4px;">
          <i class='bx bx-error'></i> <span th:text="${error}"></span>
        </div>

        <!-- Formulario estilizado -->
        <div class="form-container">
          <form th:action="@{/proveedores/salvar}"
                method="post"
                th:object="${proveedor}"
                class="supplier-form">

            <!-- Campo oculto para ID al editar -->
            <input type="hidden" th:if="${Editando}" th:field="*{idProveedor}"/>
            <input type="hidden" th:if="${Editando}" th:field="*{idPersona.idPersona}"/>
            <input type="hidden" th:if="${Editando}" th:field="*{informacionComercial.idInfoComerc}"/>
            <input type="hidden" id="originalNitRut" name="originalNitRut" th:value="${proveedor.informacionComercial?.nitRut}"/>

            <h3 th:text="${Editando} ? 'Editar proveedor' : 'Nuevo proveedor'"></h3>

            <!-- Sección: Información Personal (NUEVA - similar a contratistas) -->
            <div class="form-section">
              <div class="section-header">
                <i class='bx bx-user'></i>
                <h3>Información Personal</h3>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="nombre">
                    <i class='bx bx-user-circle'></i>
                    Nombre *
                  </label>
                  <input type="text"
                         id="nombre"
                         th:field="*{idPersona.nombre}"
                         required
                         class="form-input"
                         placeholder="Nombre del contacto" />
                  <span class="error" th:errors="*{idPersona.nombre}" style="color: red; font-size: 0.9em;"></span>
                </div>

                <div class="form-group">
                  <label for="apellido">
                    <i class='bx bx-user-circle'></i>
                    Apellido *
                  </label>
                  <input type="text"
                         id="apellido"
                         th:field="*{idPersona.apellido}"
                         required
                         class="form-input"
                         placeholder="Apellido del contacto" />
                  <span class="error" th:errors="*{idPersona.apellido}" style="color: red; font-size: 0.9em;"></span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="telefono">
                    <i class='bx bx-phone'></i>
                    Teléfono *
                  </label>
                  <input type="tel"
                         id="telefono"
                         th:field="*{idPersona.telefono}"
                         required
                         class="form-input"
                         placeholder="Número de teléfono" />
                  <span class="error" th:errors="*{idPersona.telefono}" style="color: red; font-size: 0.9em;"></span>
                </div>

                <div class="form-group">
                  <label for="correo">
                    <i class='bx bx-envelope'></i>
                    Correo Personal *
                  </label>
                  <input type="email"
                         id="correo"
                         th:field="*{idPersona.correo}"
                         required
                         class="form-input"
                         placeholder="correo@ejemplo.com" />
                  <span class="error" th:errors="*{idPersona.correo}" style="color: red; font-size: 0.9em;"></span>
                </div>
              </div>
            </div>

            <!-- Sección: Información Comercial -->
            <div class="form-section">
              <div class="section-header">
                <i class='bx bx-building'></i>
                <h3>Información Comercial</h3>
              </div>

              <!-- Selector de información comercial existente (solo en creación) -->
              <div class="form-group" th:if="${!Editando}">
                <label for="existingCommercialInfo">
                  <i class='bx bx-receipt'></i>
                  Usar información comercial existente:
                </label>
                <select id="existingCommercialInfo"
                        name="existingCommercialInfoId"
                        class="form-select">
                  <option value="">-- Crear nueva información comercial --</option>
                  <option th:each="info : ${informacionesComerciales}"
                          th:value="${info.idInfoComerc}"
                          th:attr="data-nit=${info.nitRut},
                         data-email=${info.correoElectronico},
                         data-producto=${info.producto},
                         data-forma-pago=${info.formaPago},
                         data-banco=${info.banco},
                         data-cuenta=${info.numCuenta},
                         data-direccion=${info.direccion}"
                          th:text="${info.nitRut + ' - ' + info.correoElectronico}">
                  </option>
                </select>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="nitRut">
                    <i class='bx bx-id-card'></i>
                    NIT/RUT *
                  </label>
                  <input type="text"
                         id="nitRut"
                         th:field="*{informacionComercial.nitRut}"
                         required
                         th:readonly="${Editando}"
                         class="form-input"
                         placeholder="Ej: 890.123.456-7" />
                  <span class="error" th:errors="*{informacionComercial.nitRut}" style="color: red; font-size: 0.9em;"></span>
                </div>

                <div class="form-group">
                  <label for="correoElectronico">
                    <i class='bx bx-envelope'></i>
                    Correo Electrónico Comercial *
                  </label>
                  <input type="email"
                         id="correoElectronico"
                         th:field="*{informacionComercial.correoElectronico}"
                         required
                         class="form-input"
                         placeholder="empresa@correo.com" />
                  <span class="error" th:errors="*{informacionComercial.correoElectronico}" style="color: red; font-size: 0.9em;"></span>
                </div>

                <div class="form-group full-width">
                  <label for="producto">
                    <i class='bx bx-package'></i>
                    Producto/Servicio *
                  </label>
                  <input type="text"
                         id="producto"
                         th:field="*{informacionComercial.producto}"
                         required
                         class="form-input"
                         placeholder="Descripción del producto o servicio" />
                  <span class="error" th:errors="*{informacionComercial.producto}" style="color: red; font-size: 0.9em;"></span>
                </div>

                <div class="form-group">
                  <label for="formaPago">
                    <i class='bx bx-credit-card'></i>
                    Forma de Pago
                  </label>
                  <select id="formaPago"
                          th:field="*{informacionComercial.formaPago}"
                          class="form-select">
                    <option value="">-- Seleccione --</option>
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TRANSFERENCIA">Transferencia Bancaria</option>
                    <option value="CHEQUE">Cheque</option>
                    <option value="CREDITO">Crédito</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="banco">
                    <i class='bx bx-bank'></i>
                    Banco
                  </label>
                  <input type="text"
                         id="banco"
                         th:field="*{informacionComercial.banco}"
                         class="form-input"
                         placeholder="Ej: Bancolombia" />
                </div>

                <div class="form-group">
                  <label for="numCuenta">
                    <i class='bx bx-credit-card-alt'></i>
                    Número de Cuenta
                  </label>
                  <input type="text"
                         id="numCuenta"
                         th:field="*{informacionComercial.numCuenta}"
                         class="form-input"
                         placeholder="Ej: 123456789" />
                </div>

                <div class="form-group full-width">
                  <label for="direccion">
                    <i class='bx bx-map'></i>
                    Dirección
                  </label>
                  <input type="text"
                         id="direccion"
                         th:field="*{informacionComercial.direccion}"
                         class="form-input"
                         placeholder="Dirección completa" />
                </div>
              </div>

              <!-- Botones de acción -->
              <div class="form-actions">
                <a th:href="@{/proveedores/inicioProveedor}" class="btn-cancel">
                  <i class='bx bx-x'></i>
                  Cancelar
                </a>
                <button type="submit" class="btn-save">
                  <i class='bx bx-save'></i>
                  <span th:text="${Editando} ? 'Actualizar Proveedor' : 'Guardar Proveedor'"></span>
                </button>
              </div>
            </div>
          </form>
        </div>

      </div>
    </main>
</div>
<!-- JavaScript para funcionalidad adicional -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Validación en tiempo real
    const form = document.querySelector('.supplier-form');
    const inputs = form.querySelectorAll('.form-input, .form-select');

    inputs.forEach(input => {
      input.addEventListener('blur', function() {
        validateField(this);
      });
    });

    function validateField(field) {
      const value = field.value.trim();

      if (field.hasAttribute('required') && !value) {
        field.style.borderColor = '#dc3545';
        return false;
      } else {
        field.style.borderColor = '#28a745';
        return true;
      }
    }

    // Validación del formulario
    form.addEventListener('submit', function(e) {
      let isValid = true;

      inputs.forEach(input => {
        if (!validateField(input)) {
          isValid = false;
        }
      });

      if (!isValid) {
        e.preventDefault();
        alert('Por favor complete todos los campos requeridos');
      }
    });

    // Formatear NIT mientras se escribe
    const nitInput = document.getElementById('nitRut');
    if (nitInput) {
      nitInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, ''); // Solo números
        if (value.length >= 9) {
          value = value.substring(0, 9) + '-' + value.substring(9, 10);
        }
        this.value = value;
      });
    }

    // Manejar selección de información comercial existente
    const existingCommercialInfo = document.getElementById('existingCommercialInfo');
    if (existingCommercialInfo) {
      existingCommercialInfo.addEventListener('change', function() {
        if (this.value) {
          // Obtener la información comercial del option seleccionado
          const selectedOption = this.options[this.selectedIndex];
          const nitRut = selectedOption.getAttribute('data-nit');
          const correoElectronico = selectedOption.getAttribute('data-email');
          const producto = selectedOption.getAttribute('data-producto');
          const formaPago = selectedOption.getAttribute('data-forma-pago');
          const banco = selectedOption.getAttribute('data-banco');
          const numCuenta = selectedOption.getAttribute('data-cuenta');
          const direccion = selectedOption.getAttribute('data-direccion');

          // Llenar los campos con la información comercial
          if (nitRut) document.getElementById('nitRut').value = nitRut;
          if (correoElectronico) document.getElementById('correoElectronico').value = correoElectronico;
          if (producto) document.getElementById('producto').value = producto;
          if (formaPago) document.getElementById('formaPago').value = formaPago;
          if (banco) document.getElementById('banco').value = banco;
          if (numCuenta) document.getElementById('numCuenta').value = numCuenta;
          if (direccion) document.getElementById('direccion').value = direccion;

          // Deshabilitar campos para evitar modificación
          document.getElementById('nitRut').disabled = true;
          document.getElementById('correoElectronico').disabled = true;
          document.getElementById('producto').disabled = true;
          document.getElementById('formaPago').disabled = true;
          document.getElementById('banco').disabled = true;
          document.getElementById('numCuenta').disabled = true;
          document.getElementById('direccion').disabled = true;
        } else {
          // Habilitar campos si se selecciona "Crear nueva"
          document.getElementById('nitRut').disabled = false;
          document.getElementById('correoElectronico').disabled = false;
          document.getElementById('producto').disabled = false;
          document.getElementById('formaPago').disabled = false;
          document.getElementById('banco').disabled = false;
          document.getElementById('numCuenta').disabled = false;
          document.getElementById('direccion').disabled = false;

          // Limpiar campos
          document.getElementById('nitRut').value = '';
          document.getElementById('correoElectronico').value = '';
          document.getElementById('producto').value = '';
          document.getElementById('formaPago').value = '';
          document.getElementById('banco').value = '';
          document.getElementById('numCuenta').value = '';
          document.getElementById('direccion').value = '';
        }
      });
    }

    // Limpiar campos al cargar la página si estamos en modo creación
    const isEditando = document.querySelector('input[th\\:if*="Editando"]') !== null;
    if (!isEditando) {
      // Asegurarse de que los campos estén limpios al cargar
      setTimeout(() => {
        if (existingCommercialInfo && existingCommercialInfo.value === '') {
          document.getElementById('nitRut').value = '';
          document.getElementById('correoElectronico').value = '';
          document.getElementById('producto').value = '';
          document.getElementById('formaPago').value = '';
          document.getElementById('banco').value = '';
          document.getElementById('numCuenta').value = '';
          document.getElementById('direccion').value = '';
        }
      }, 100);
    }

    // LÓGICA DE CONTROL DEL MENÚ MÓVIL (Añadida)
    // =========================================================================================
    const menuToggle = document.getElementById('menu-toggle');
    const appContainer = document.getElementById('app-container');
    const sidebar = document.querySelector('.sidebar');
    const menuIcon = menuToggle ? menuToggle.querySelector('i') : null;

    if (menuToggle && appContainer && sidebar && menuIcon) {
        // 1. Alternar la clase y el ícono al hacer clic
        menuToggle.addEventListener('click', function() {
            appContainer.classList.toggle('sidebar-active');

            // Cambiar el ícono (fa-bars <-> fa-times)
            if (appContainer.classList.contains('sidebar-active')) {
                menuIcon.classList.replace('fa-bars', 'fa-times');
            } else {
                menuIcon.classList.replace('fa-times', 'fa-bars');
            }
        });

        // 2. Cerrar el menú al hacer clic fuera (solo en móvil)
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && appContainer.classList.contains('sidebar-active')) {
                // Si el clic no fue dentro del menú ni dentro del botón de toggle
                if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    appContainer.classList.remove('sidebar-active');
                    menuIcon.classList.replace('fa-times', 'fa-bars');
                }
            }
        });
    }
  });
</script>
</body>
</html>